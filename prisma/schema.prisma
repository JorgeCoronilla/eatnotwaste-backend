// FreshKeeper v2.0.0 - Prisma Schema
// PostgreSQL database schema for the unified design

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum ListType {
  shopping
  fridge
  freezer
  pantry
}

enum ProductSource {
  openfoodfacts
  chomp
  manual
  catalog
}

enum MovementType {
  add
  remove
  move
  consume
  expire
  update
}

enum Platform {
  android
  ios
  web
}

enum NotificationStatus {
  sent
  delivered
  failed
  read
  clicked
}

// Models
model User {
  id              String   @id @default(uuid()) @db.Uuid
  email           String   @unique @db.VarChar(255)
  passwordHash    String?  @map("password_hash") @db.VarChar(255)
  googleId        String?  @map("google_id") @db.VarChar(255) @unique
  name            String   @db.VarChar(255)
  avatarUrl       String?  @map("avatar_url") @db.Text
  language        String   @default("es") @db.VarChar(10)
  timezone        String   @default("UTC") @db.VarChar(50)
  preferences     Json     @default("{}")
  isActive        Boolean  @default(true) @map("is_active")
  emailVerified   Boolean  @default(false) @map("email_verified")
  lastLogin       DateTime? @map("last_login") @db.Timestamptz
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  userItems               UserItem[]
  itemMovements          ItemMovement[]
  deviceTokens           UserDeviceToken[]
  notificationHistory    NotificationHistory[]
  notificationSettings   UserNotificationSettings?

  @@map("users")
}

model Product {
  id               String        @id @default(uuid()) @db.Uuid
  barcode          String?       @db.VarChar(50)
  name             String        @db.VarChar(255)
  brand            String?       @db.VarChar(255)
  category         String?       @db.VarChar(100)
  subcategory      String?       @db.VarChar(100)
  description      String?       @db.Text
  imageUrl         String?       @map("image_url") @db.Text
  nutritionalInfo  Json          @default("{}") @map("nutritional_info")
  allergens        String[]      @db.Text
  ingredients      String?       @db.Text
  source           ProductSource @default(manual)
  sourceId         String?       @map("source_id") @db.VarChar(255)
  isVerified       Boolean       @default(false) @map("is_verified")
  createdAt        DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime      @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  userItems        UserItem[]
  itemMovements    ItemMovement[]

  @@map("products")
}

model UserItem {
  id            String    @id @default(uuid()) @db.Uuid
  userId        String    @map("user_id") @db.Uuid
  productId     String    @map("product_id") @db.Uuid
  listType      ListType  @map("list_type")
  quantity      Int       @default(1)
  unit          String    @default("units") @db.VarChar(50)
  purchaseDate  DateTime? @map("purchase_date") @db.Date
  expiryDate    DateTime? @map("expiry_date") @db.Date
  price         Decimal?  @db.Decimal(10, 2)
  store         String?   @db.VarChar(255)
  notes         String?   @db.Text
  isConsumed    Boolean   @default(false) @map("is_consumed")
  consumedAt    DateTime? @map("consumed_at") @db.Timestamptz
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  movements     ItemMovement[]

  @@unique([userId, productId, listType, purchaseDate, expiryDate])
  @@map("user_items")
}

model ItemMovement {
  id           String       @id @default(uuid()) @db.Uuid
  userId       String       @map("user_id") @db.Uuid
  userItemId   String?      @map("user_item_id") @db.Uuid
  productId    String       @map("product_id") @db.Uuid
  movementType MovementType @map("movement_type")
  fromList     ListType?    @map("from_list")
  toList       ListType?    @map("to_list")
  quantity     Int
  unit         String       @default("units") @db.VarChar(50)
  metadata     Json         @default("{}")
  createdAt    DateTime     @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userItem     UserItem?    @relation(fields: [userItemId], references: [id], onDelete: SetNull)
  product      Product      @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("item_movements")
}

model ProductCache {
  id          String   @id @default(uuid()) @db.Uuid
  barcode     String   @db.VarChar(50)
  source      ProductSource
  productData Json     @map("product_data")
  lastUpdated DateTime @default(now()) @map("last_updated") @db.Timestamptz
  expiresAt   DateTime @default(dbgenerated("(CURRENT_TIMESTAMP + INTERVAL '30 days')")) @map("expires_at") @db.Timestamptz
  hitCount    Int      @default(1) @map("hit_count")

  @@unique([barcode, source])
  @@map("product_cache")
}

model UserDeviceToken {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  deviceId    String   @map("device_id") @db.VarChar(255)
  fcmToken    String   @map("fcm_token") @db.Text
  platform    Platform
  appVersion  String?  @map("app_version") @db.VarChar(50)
  isActive    Boolean  @default(true) @map("is_active")
  lastUsed    DateTime @default(now()) @map("last_used") @db.Timestamptz
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user                User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  notificationHistory NotificationHistory[]

  @@unique([userId, deviceId])
  @@map("user_device_tokens")
}

model NotificationHistory {
  id            String             @id @default(uuid()) @db.Uuid
  userId        String             @map("user_id") @db.Uuid
  deviceTokenId String?            @map("device_token_id") @db.Uuid
  notificationType String          @map("notification_type") @db.VarChar(50)
  title         String             @db.VarChar(255)
  body          String             @db.Text
  data          Json               @default("{}")
  sentAt        DateTime           @default(now()) @map("sent_at") @db.Timestamptz
  deliveredAt   DateTime?          @map("delivered_at") @db.Timestamptz
  readAt        DateTime?          @map("read_at") @db.Timestamptz
  clickedAt     DateTime?          @map("clicked_at") @db.Timestamptz
  status        NotificationStatus @default(sent)

  // Relations
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceToken UserDeviceToken? @relation(fields: [deviceTokenId], references: [id], onDelete: SetNull)

  @@map("notification_history")
}

model UserNotificationSettings {
  id                    String   @id @default(uuid()) @db.Uuid
  userId                String   @unique @map("user_id") @db.Uuid
  expiryAlerts          Boolean  @default(true) @map("expiry_alerts")
  expiryDaysBefore      Int      @default(2) @map("expiry_days_before")
  shoppingReminders     Boolean  @default(true) @map("shopping_reminders")
  shoppingReminderTime  String   @default("10:00:00") @map("shopping_reminder_time") @db.VarChar(8)
  shoppingReminderDays  Int[]    @default([1, 3, 5]) @map("shopping_reminder_days")
  weeklySummary         Boolean  @default(true) @map("weekly_summary")
  weeklySummaryDay      Int      @default(0) @map("weekly_summary_day")
  weeklySummaryTime     String   @default("18:00:00") @map("weekly_summary_time") @db.VarChar(8)
  recommendations       Boolean  @default(true)
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_notification_settings")
}
